---
######################################
# Click on "Run Document" in RStudio #
######################################
title: "The Three Approximations in ABC"
author: "Miguel de Navascu√©s"
output: learnr::tutorial
runtime: shiny_prerendered
---

These learning resources are available at [GitHub](https://github.com/mnavascues/ABCRFtutorial) & [Zenodo](http://doi.org/10.5281/zenodo.1435503).

## Setup (tl;dr)

```{r setup, include=TRUE}
library(learnr)
# function ms() (Hudson's coalescent simulator)
library(phyclust, quietly=T)
# functions for ABC
suppressMessages(library(abc, quietly=T))
# functions for the coin toss experiment analysis
source("coin_toss.R", local = TRUE)
# function read.ms.output()
source("readms.output.R", local =T)
# functions to calculate summary statistics from ms output
source("ms_sumstats.R", local =T)
```

## Approximation 1: Simulation

Approximate Bayesian Computation is a likelihood-free model-based inference approach. The idea behind likelihood-free methods is that the analytical/numerical calculating of the likelihood is substituted by an estimate of the likelihood based on simulations.

### Exercise 1

For the coin toss experiment, estimate the likelihood of $p=0.5$ for $h=4$ and $t=6$ using simulations.

* The true value (for $p=0.5$, $h=4$ and $t=6$) is `r choose(10, 4) * 0.5^10`. Is the estimate reasonable?
* How can the estimate be improved?

```{r simulation_coin_toss_rbinom, exercise=TRUE}
h = 4; t = 6; p = 0.5
n <- h+t
num_of_sim = _____
h_prime <- rbinom(n=num_of_sim,size=n,prob=p)
_____
```

```{r simulation_coin_toss_rbinom-hint}
h = 4; t = 6; p = 0.5
n <- h+t
num_of_sim = 100
h_prime <- rbinom(n=num_of_sim,size=n,prob=p)
_____(h_prime==h)/_____
```

```{r simulation_coin_toss_rbinom-solution}
h = 4; t = 6; p = 0.5
n <- h+t
num_of_sim = 100
h_prime <- rbinom(n=num_of_sim,size=n,prob=p)
sum(h_prime==h)/num_of_sim
```



### Exercise 2

Plot the likelihood profile from using simulation-based estimates of the likelihood by running the code provided.

* Compare the results with the analytical solution.
* Why should we bother about a (slower, less accurate) simulation-based solution?

For this exercise you have two functions available, `flip_coin_likelihood()` and `flip_coin_likelihood_approx()`, that have been loaded using:


```{r eval=FALSE, echo=TRUE}
source("coin_toss.R")
```


```{r likelihood_function, exercise=TRUE}
h = 4; t = 6; num_of_sim = 1000
p = seq(0,1,0.01)
l_profile_true   <- flip_coin_likelihood(p,h,t)
l_profile_approx <- flip_coin_likelihood_approx(p,h,t,num_of_sim)
plot(l_profile_approx$p, l_profile_approx$l,
     xlab = "p", ylab = "Likelihood", type = "l", col = "red", lwd=2)
lines(l_profile_true$p, l_profile_true$l,
      col = "red")
```


Posterior probabilities can be also estimated through the use of simulations using the **rejection algorithm**. The following procedure produces a sample from the posterior probability distribution (remember that $P(p|D)\propto L(p|D)P(p)$):

***

**Algorithm 1** Exact rejection sampler

* Given $N$ the number of simulations
* **for** $i=1$ to $N$ **do**
  + Generate $p'\sim\pi(p)$
  + Simulate $D'\sim f(p')$
  + **if** $D'=D$ **then**
    - Accept $p'$
  + **end if**
* **end for** 
* **return** accepted $p'$ 

***

### Exercise 3

Obtain a sample from the posterior probability distribution with the rejection algorithm:

```{r exact_rejection_sampling, exercise=TRUE, exercise.lines=8}
h=4; t=6
a=1; b=1; num_of_sim=1000
p_prime <- _____ # sample from prior distribution (use a beta)
d_prime <- _____ # simulate coin tosses (with binomial)
p_prime_accept <- _____ # keep the values that are equal to the observed data
p_prime_accept
```

```{r exact_rejection_sampling-hint-1}
h=4; t=6
a=1; b=1; num_of_sim=1000
p_prime <- rbeta(num_of_sim,a,b)
d_prime <- _____ # simulate coin tosses (with binomial)
p_prime_accept <- _____ # keep the values that are equal to the observed data
p_prime_accept
```

```{r exact_rejection_sampling-hint-2}
h=4; t=6
a=1; b=1; num_of_sim=1000
p_prime <- rbeta(num_of_sim,a,b)
d_prime <- rbinom(n    = num_of_sim,
                  size = h+t,
                  prob = p_prime)
p_prime_accept <- _____ # keep the values that are equal to the observed data
p_prime_accept
```


```{r exact_rejection_sampling-solution}
h=4; t=6
a=1; b=1; num_of_sim=1000
p_prime <- rbeta(num_of_sim,a,b)
d_prime <- rbinom(n    = num_of_sim,
                  size = h+t,
                  prob = p_prime)
p_prime_accept <- p_prime[which(d_prime==h)]
p_prime_accept
```

### Exercise 4

Use `flip_coin_posterior_approx()` function to crate a sample from the posterior probability distribution.

* Create a scatter plot to show the parameter value $p'$ and data $D'$ for all simulations.
* Highlight simulations that match observed data $D$.
* Then, use the sample of the posterior probability to plot an estimate of the posterior probability distribution (hint: use `hist()`).


```{r plot_posterior_approx, exercise=TRUE, exercise.lines=20, exercise.setup="flip_coin_posterior_approx"}
h=4;t=6;a=1;b=1;num_of_sim=1000
res <- flip_coin_posterior_approx(h,t,a,b,num_of_sim)

```

```{r plot_posterior_approx-hint}
h=4;t=6;a=1;b=1;num_of_sim=1000
res <- flip_coin_posterior_approx(h,t,a,b,num_of_sim)
plot(res$p_prime,res$d_prime,
     xlab = expression(italic(p)*"'"),
     ylab = expression(italic(D)*"'"))
abline(h = h, col = "blue")
points(res$p_prime_accept, res$d_prime_accept, col = "blue")

```



```{r plot_posterior_approx-solution}
h=4;t=6;a=1;b=1;num_of_sim=1000
res <- flip_coin_posterior_approx(h,t,a,b,num_of_sim)
plot(res$p_prime,res$d_prime,
     xlab = expression(italic(p)*"'"),
     ylab = expression(italic(D)*"'"))
abline(h = h, col = "blue")
points(res$p_prime_accept, res$d_prime_accept, col = "blue")
hist(res$p_prime,
     breaks = seq(0,1,0.02),
     col = "grey",
     freq = FALSE,
     ylim = c(0,5),
     main = "", xlab = expression(italic(p)),
     ylab = "probability density")
hist(res$p_prime_accept,
     breaks = seq(0,1,0.02),
     col = "blue",
     freq = FALSE, add = TRUE); box()
lines(seq(0,1,0.001),dbeta(x=seq(0,1,0.001),a+h,b+t),
      col = "blue", lwd = 3)
```


### Exercise 5

Get a point estimate and the 95% credibility interval (CI).

* For data $h=4$ and $t=6$, and prior $\mathrm{Beta}(\alpha=1,\beta=1)$, the posterior is $\mathrm{Beta}(\alpha=5,\beta=7)$ whose median is `r qbeta(0.5,1+4,1+6)` and the 95% CI is (`r qbeta(c(0.025,0.975),1+4,1+6)`). Are the ABC point estimate and CI accurate?


```{r coin_toss_credibility_interval, exercise=TRUE, exercise.setup="flip_coin_posterior_approx"}
h=4;t=6;a=1;b=1;num_of_sim=1000
res <- flip_coin_posterior_approx(h,t,a,b,num_of_sim)
p_hat  <- _____
p_95CI <- _____
p_hat; p_95CI
```

```{r coin_toss_credibility_interval-hint}
h=4;t=6;a=1;b=1;num_of_sim=1000
res <- flip_coin_posterior_approx(h,t,a,b,num_of_sim)
p_hat  <- _____(res$p_prime_accept)
p_95CI <- quantile(_____,probs=c(0.025,0.975))
p_hat; p_95CI
```



```{r coin_toss_credibility_interval-solution}
h=4;t=6;a=1;b=1;num_of_sim=1000
res <- flip_coin_posterior_approx(h,t,a,b,num_of_sim)
p_hat  <- median(res$p_prime_accept)
p_95CI <- quantile(res$p_prime_accept,probs=c(0.025,0.975))
p_hat; p_95CI
```



## Approximation 2: Summary Statistics

We are going to consider now population genetics data. We have two data sets of mitochondrial DNA sequences for 50 individuals of two different hermaphrodite *mammollusks*. The data is in two files named `octomanati.txt` and `rinocaracol.txt` in *ms* format.


<figure>
[<img src="https://upload.wikimedia.org/wikipedia/commons/4/42/Octomanati.png" alt="heads" style="height: 234px; width:352px;"/>](https://commons.wikimedia.org/wiki/File:Octomanati.png)[<img src="https://upload.wikimedia.org/wikipedia/commons/9/96/Rinocaracol.png" alt="heads" style="height: 234px; width:352px;"/>](https://commons.wikimedia.org/wiki/File:Rinocaracol.png)
<figcaption align = "center">*Octomanati* and *rinocaracol*. Names and images by [Javier Gamboa](https://commons.wikimedia.org/wiki/User:Javiesgm) ([CC-BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/deed.en)).</figcaption>
</figure>


### Exercise 6

Explore the data (you can use functions `S()`, `NH()`, `PI()`, `TajimaD()` and `FuLiD()`).

* How many polymorphic sites are there?  How would you apply the rejection algorithm?

```{r explore_genetic_data, exercise=TRUE, exercise.lines=6}
octomanati_data  <- read.ms.output(file="/change/to/your/path/octomanati.txt")
rinocaracol_data <- read.ms.output(file="/home/miguel/Work/Teaching/ABCRF tutorial/rinocaracol.txt")
```

```{r explore_genetic_data-solution}
octomanati_data  <- read.ms.output(file="/change/to/your/path/octomanati.txt")
rinocaracol_data <- read.ms.output(file="/home/miguel/Work/Teaching/ABCRF tutorial/rinocaracol.txt")

cat("octomanati dataset has",S(octomanati_data),"segregating sites")
cat("rinocaracol dataset has",S(rinocaracol_data),"segregating sites")
```


We could try to apply the same rejection algorithm described above, but the structure of the data is more complex and an exact match would occur rarely in simulations. So we use the second approximation of ABC, instead of the data we use summary statistics ($S$) from the data to classify the simulation as a match to the observation. It is said now that we are approximating the likelihood of $p$ given the summary statistic, $L(p|S)$, rather than the likelihood of $p$ given the data, $L(p|D)$.

***

**Algorithm 2** Exact rejection sampler on summary statistics

* Calculate $S$ from $D$  
* Given $N$ the number of simulations  
* **for** $i = 1$ to $N$ **do**  
  + Generate $p'\sim\pi(p)$  
  + Simulate $D'\sim f(p')$  
  + Calculate $S'$ from $D'$  
  + **if** $S'=S$ **then**  
    - Accept $p'$  
  + **end if**  
* **end for**  
* **return** accepted $p'$  

***

### Exercise 7

Simulate sequence data with `ms` (from `phyclust` package) using the standard coalescent model (single population of constant size). Simulate with $\theta$ values taken from a log-uniform prior probability distribution (option `"-t tbs"`). [just click `Run code`]

```{r simulation_coalescent, exercise=TRUE}
sample_size = 50
num_of_sim = 10
theta_prime <- 10^runif(num_of_sim,min=-1,max=2)
cat("theta values are:");theta_prime
msout <- ms(nsam = sample_size,
            opt = "-t tbs",
            tbs.matrix = cbind(theta_prime))
msout <- read.ms.output(txt=msout)
cat("number of segregating sites are:");S(msout)
cat("pi values are:");PI(msout)
```

Simulation can be very time consuming, for the following exercises we will be using a set of simulations which have already been run and summary statistics calculated from them (this is called the **reference table**). This reference table has been produced with the following code:

```{r eval=FALSE, echo=TRUE}
sample_size = 50
num_of_sim = 100000
theta_prime <- 10^runif(num_of_sim,min=-1,max=2)
msout <- ms(nsam = sample_size,
            opt = "-t tbs -T",
            tbs.matrix = cbind(theta_prime))
tmrca <- theta_prime*sapply(read.tree(text = msout[grep("//",msout)+1]),
                            get.rooted.tree.height)
msout <- read.ms.output(txt=msout)
S_prime  <- S(msout)
PI_prime <- PI(msout)
NH_prime <- NH(msout)
TD_prime <- TajimaD(msout)
FLD_prime <- FuLiD(msout)
ref_table <- data.frame(theta=theta_prime,
                        tmrca=tmrca,
                        S=S_prime,
                        PI=PI_prime,
                        NH=NH_prime,
                        TD=TD_prime,
                        FLD=FLD_prime)
saveRDS(ref_table,file="ref_table_1.RDS")
```

The summary statistics for our two target species has been calculated with the same functions. It has been saved as:


```{r eval=FALSE, echo=TRUE}
target <- data.frame(S  = c(50,23),
                     PI = c(11.56163,1.354286),
                     NH = c(21,18),
                     TD = c(0.123358,-2.386268),
                     FLD= c(-1.160349,-4.354524),
                     row.names = c("octomanati","rinocaracol"))
saveRDS(target,file="target.RDS")
```




### Exercise 8

Apply the rejection algorithm using one summary statistic on the *mammollusk* data.

* Start with the number of segregating sites and the number of haplotypes (`S`, `NH`), then try $\pi$ (`PI`). How many simulations are being accepted?
* Make the same plots as in exercise 4 to help you explore.

```{r rejection_algortihm_sumstats, exercise=TRUE, exercise.lines=35}
target    <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/target.RDS")
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")

```

```{r rejection_algortihm_sumstats-hint-1}
target    <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/target.RDS")
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")
target
head(ref_table)
```



```{r rejection_algortihm_sumstats-hint-2}
target    <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/target.RDS")
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")

num_of_sims <- 10000 # use a subset of simulation from a total of 1 000 000

SS          <- target$S[1]
SS_prime    <- ref_table$S[seq_len(num_of_sims)]
theta_prime <- ref_table$theta[seq_len(num_of_sims)]
theta_prime_accept <- theta_prime[which(SS_prime==SS)] 
SS_prime_accept <- SS_prime[which(SS_prime==SS)] 

cat("This is a sample of the posterior (using S):")
(theta_prime_accept)

SS          <- target$PI[1]
SS_prime    <- ref_table$PI[seq_len(num_of_sims)]
theta_prime <- ref_table$theta[seq_len(num_of_sims)]
theta_prime_accept <- theta_prime[which(SS_prime==SS)] 
SS_prime_accept <- SS_prime[which(SS_prime==SS)] 

cat("This is a sample of the posterior (using PI):")
(theta_prime_accept)


```



```{r rejection_algortihm_sumstats-solution}
target    <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/target.RDS")
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")

num_of_sims <- 10000 # use a subset of simulation from a total of 1 000 000

SS          <- target$PI[1]
SS_prime    <- ref_table$PI[seq_len(num_of_sims)]
theta_prime <- ref_table$theta[seq_len(num_of_sims)]
theta_prime_accept <- theta_prime[which(SS_prime==SS)] 
SS_prime_accept <- SS_prime[which(SS_prime==SS)] 

plot(log10(theta_prime),SS_prime,
     xlab = expression(log[10](theta*"'")),
     ylab = "S'",
     ylim = c(0,100))
abline(h = SS, col = "blue")
points(log10(theta_prime_accept), SS_prime_accept, col = "blue")
hist(log10(theta_prime),
     breaks = seq(-1,2,0.05),
     col = "grey",
     freq = FALSE,
     ylim = c(0,4),
     main = "", xlab = expression(log[10](theta)),
     ylab = "probability density")
hist(x = log10(theta_prime_accept),
     breaks = seq(-1,2,0.05),
     col = "blue",
     freq = FALSE,
     add = TRUE)
```

## Approximation 3: Tolerance

Summarizing the data into summary statistics is not enough. The third kind of approximation in ABC is to introduce some tolerance so simulations that are closer to the observed data are accepted:

***

**Algorithm 3** Rejection sampler on summary statistics with tolerance

* Calculate $S$ from $D$  
* Given $N$ the number of simulations  
* **for** $i = 1$ to $N$ **do**  
  + Generate $p'\sim\pi(p)$  
  + Simulate $D'\sim f(p')$  
  + Calculate $S'$ from $D'$  
  + **if** distance$(S',S)<\delta$ **then**  
    - Accept $p'$  
  + **end if**  
* **end for**  
* **return** accepted $p'$  

***

Note that, in practice, a proportion of simulations closest to the observation is accepted and this proportion is decided *a priori*. The $\delta$ is fixed *a posteriori* by the furthest simulation within the set of accepted simulations.

From this moment, for convenience, we will start using the package `abc` that has been loaded in the setup.

### Exercise 9

Using function `abc()` (from `abc` package), apply the rejection algorithm using one summary statistic:

* Start with the number of segregating sites and the number of haplotypes (`S`). [use code provided]
* Try now using $\pi$ (`PI`).
* Explore the effect of changing the tolerance level (proportion of simulations kept), try values `0.5` and `0.001`. What would we get as posterior using tolerance values close to `1`?
* Try with more than one summary statistic. How do you think the distance is being in this case?

```{r rejection_algortihm_tolerance, exercise=TRUE, exercise.lines=35}
target    <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/target.RDS")
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")

num_of_sims <- 10000 # use a subset of simulation from a total of 1 000 000

SS          <- target$S[1]
SS_prime    <- ref_table$S[seq_len(num_of_sims)]
theta_prime <- ref_table$theta[seq_len(num_of_sims)]

tolerance <- 0.05
abc_result <- abc(target = SS,
                  param = theta_prime,
                  sumstat = SS_prime,
                  tol = tolerance,
                  method = "rejection")
theta_prime_accept <- as.vector(abc_result$unadj.values)
SS_prime_accept <- abc_result$ss

plot(log10(theta_prime),SS_prime,
     xlab = expression(log[10](theta*"'")),
     ylab = "S'",
     ylim = c(0,100))
abline(h = SS, col = "blue")
points(log10(theta_prime_accept), SS_prime_accept, col = "blue")
hist(log10(theta_prime),
     breaks = seq(-1,2,0.05),
     col = "grey",
     freq = FALSE,
     ylim = c(0,4),
     main = "", xlab = expression(log[10](theta)),
     ylab = "probability density")
hist(x = log10(theta_prime_accept),
     breaks = seq(-1,2,0.05),
     col = "blue",
     freq = FALSE,
     add = TRUE)
```


