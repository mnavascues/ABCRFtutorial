---
######################################
# Click on "Run Document" in RStudio #
######################################
title: "Quick Introduction to Simulation"
author: "Miguel de Navascu√©s"
output: learnr::tutorial
runtime: shiny_prerendered
---

This course is available at [Zenodo](http://doi.org/10.5281/zenodo.1435503).



## Setup (just for information)


```{r setup, include=TRUE}
library(learnr)
library(phyclust, quietly=T)

# for function read.ms.output()
source("readms.output.R", local =T)

# functions to calculate summary statistics from ms output
S <- function(a) {return(a$segsites)}

NH <- function(a) {
  NH<-vector(length=a$nreps)
  for(i in seq_len(a$nreps)) {
    NH[i] <- nrow(unique(a$gametes[[i]]))
  }
  return(NH)
}

PI <- function(a) {
  PI<-vector(mode='numeric', length=a$nreps)
  for(i in seq_len(a$nreps)) {
    if(a$segsites[i]>0){
      for(j in seq_len(a$segsites[i])) {
         if(a$segsites[i]>1) {
          loc<-sum(a$gametes[[i]][,j])
        } else {
          loc<-sum(a$gametes[[i]])
        }
        PI[i] <- PI[i] + 2*loc*(a$nsam-loc)
      }
    }
  }
  return(PI/(a$nsam*(a$nsam-1)))
}

thetaW <- function(a) {
  a1<-sum(1/(1:(a$nsam-1)))
  return(a$segsites/a1)
}

TajimaD <- function(a) {
  a1<-sum(1/(1:(a$nsam-1)))
  a2<-sum(1/((1:(a$nsam-1))^2))
  b1<-(a$nsam+1)/3/(a$nsam-1)
  b2<-2*(a$nsam^2+a$nsam+3)/(9*a$nsam*(a$nsam-1))
  c1<-b1-1/a1
  c2<-b2-(a$nsam+2)/(a1*a$nsam)+a2/(a1^2)
  temp <- c1/a1*a$segsites + c2/(a1^2+a2)*a$segsites*(a$segsites-1)
  return( (PI(a)-thetaW(a))/sqrt(temp) )
}
```

## What is a simulation?

Discuss:

- What is a computer simulation?
- What are the sources of randomness?
- How are random numbers produced in a computer?

## Simulation of a coin toss

### Exercise 1

Simulate a ten coin tosses ($n=10$) using R function `sample(_____)` and probability of getting head $p$. Use a seed for random number generator so your simulation is reproducible:


```{r simulation_coin_toss, exercise=TRUE, exercise.lines=5}
n <- 10
p <- 0.5
sample(x=c("H","T"),size=_____, replace=_____, prob=_____)
```

```{r simulation_coin_toss-hint}
n <- 10
p <- 0.5
sample(x=c("H","T"),size=n, replace=T, prob=c(p,1-p))
```

```{r simulation_coin_toss-solution}
set.seed(123456)
n <- 10
p <- 0.5
sample(x=c("H","T"),size=n, replace=T, prob=c(p,1-p))
```

### Exercise 2

Simulate directly the number of heads ($h'$) using `rbinom(_____)`:

```{r simulation_coin_toss_rbinom, exercise=TRUE}
n <- 10
p <- 0.5
num_of_sim = 1
rbinom(n=_____,size=_____,prob=_____)
```

```{r simulation_coin_toss_rbinom-solution}
n <- 10
p <- 0.5
num_of_sim = 1
rbinom(n=num_of_sim,size=n,prob=p)
```



## Simulation of population genetic data

Simulation via the coalescent. For convenience, we will use the R package `phyclust` that includes a version of coalescent simulator `ms` in this tutorial. In practice, use of other simulators (msprime, fastsimcoal or the original implementation of ms) is recommended.

```{r eval=FALSE, echo=TRUE}
library(phyclust)
```

### Exercise 3

Simulate with `ms()` a sample of $n=10$ individuals sequenced for a mitochondrial DNA locus of lenght $l=10000$bp in a population of size $N=10000$ with mutation rate (per bp) $\mu=10^{-8}$:

```{r coalescent_sim, exercise=TRUE}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim<-1
_____
ms(nsam=_____,nreps=_____,opt=_____)
```

```{r coalescent_sim-hint}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim<-1
theta <- _____
ms(nsam=_____,nreps=_____,opt=paste("-t",theta))
```


```{r coalescent_sim-solution}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim<-1
theta <- 2*N*u*l # note that l*u is an approximation!
ms(nsam=n,nreps=num_of_sim,opt=paste("-t",theta))
```

We can put this text into a more usable form (i.e. matrix of polymorphisms, etc) using a function distributed with the original software `ms`:

```{r eval=FALSE, echo=TRUE}
source("readms.output.R")
```

### Exercise 4

Use `read.ms.output()` function to read ms output and print only the genotype matrix (i.e. `gametes`).

```{r coalescent_sim_segsites, exercise=TRUE, exercise.lines=10}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim<-1
theta <- 2*N*u*l 
msout <- ms(nsam=n,nreps=num_of_sim,opt=paste("-t",theta))
sim_data <- read.ms.output(____)
_____
```

```{r coalescent_sim_segsites-hint}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim<-1
theta <- 2*N*u*l 
msout <- ms(nsam=n,nreps=num_of_sim,opt=paste("-t",theta))
sim_data <- read.ms.output(txt=msout)
sim_data$_____
```



```{r coalescent_sim_segsites-solution}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim<-1
theta <- 2*N*u*l
msout <- ms(nsam=n,nreps=num_of_sim,opt=paste("-t",theta))
sim_data <- read.ms.output(txt=msout)
sim_data$gametes
```


### Exercise 5

Calculate summary statistics (number of segregating sites, number of haplotypes, $\pi$ and Tajima's $D$) for the simulations (use functions `S()`, `NH()`, `PI()` and `TajimaD()`, see setup for details):

```{r summary_stats, exercise=TRUE, exercise.lines=15}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim <- 10
theta <- 2*N*u*l
msout <- ms(nsam=n,nreps=num_of_sim,opt=paste("-t",theta))
sim_data <- read.ms.output(txt=msout)

```

```{r summary_stats-solution}
n<-10
l<-10000
N<-10000
u<-1e-8
num_of_sim <- 10
theta <- 2*N*u*l
msout <- ms(nsam=n,nreps=num_of_sim,opt=paste("-t",theta))
sim_data <- read.ms.output(txt=msout)

S(sim_data)
NH(sim_data)
PI(sim_data)
TajimaD(sim_data)
```




