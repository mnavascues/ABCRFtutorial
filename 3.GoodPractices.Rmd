---
######################################
# Click on "Run Document" in RStudio #
######################################
title: "Good Practices in ABC"
author: "Miguel de Navascu√©s"
output: learnr::tutorial
runtime: shiny_prerendered
bibliography: references.bib
---

These learning resources are available at [Zenodo](http://doi.org/10.5281/zenodo.1435503).

## Setup (tl;dr)

```{r setup, include=TRUE}
library(learnr)
# function ms() (Hudson's coalescent simulator)
library(phyclust, quietly=T)
# functions for ABC
suppressMessages(library(abc, quietly=T))
# function for weighted histogram
suppressMessages(library(weights, quietly=T))
```

## Compare prior and posterior

Priors can be used to incorporate previous information on the parameters. In the case of our population genetics example, we could imagine to have some information on mutation rates (e.g. from pedigrees) and population sizes (from census). Since $\theta = 2N\mu$, we could draw parameters $N$ and $\mu$ from prior probability distributions and combine them to get the prior of $\theta$. Assuming that our prior knowledge on *octomanati* and *rinocaracol* point us towards mitochondrial mutation rates between $3\times 10^{-8}$ and $10^{-6}$ and effective population sizes between $1$ and $30$ million individuals, I have generated a reference table from such priors with the following code:

```{r eval=FALSE, echo=TRUE}
sample_size = 50
num_of_sim = 1000000

mu_prime <- 10^runif(num_of_sim,min=-7.5,max=-6)
N_prime <- 10^runif(num_of_sim,min=6,max=7.5)
theta_prime <- 2*N_prime*mu_prime

msout <- ms(nsam = sample_size,
            opt = "-t tbs",
            tbs.matrix = cbind(theta_prime))
msout <- read.ms.output(txt=msout)
S_prime  <- S(msout)
PI_prime <- PI(msout)
NH_prime <- NH(msout)
TD_prime <- TajimaD(msout)
FLD_prime <- FuLiD(msout)
ref_table <- data.frame(theta=theta_prime,
                        S=S_prime,
                        PI=PI_prime,
                        NH=NH_prime,
                        TD=TD_prime,
                        FLD=FLD_prime)
saveRDS(ref_table,file="ref_table_1b.RDS")
```




### Exercise 1

Using the new reference table, plot the posterior distribution from the ABC analysis [click `Run Code`]. Is the analysis informative about $\theta$? What is the summary statistics used? Is Tajima's $D$, on its own, informative about $\theta$? What is going on? Plot the prior distribution together with the posterior. 

```{r unexpected_prior, exercise=TRUE, exercise.lines=30}
target <- data.frame(S  = c(50,23),
                     PI = c(11.56163,1.354286),
                     NH = c(21,18),
                     TD = c(0.123358,-2.386268),
                     FLD= c(-1.160349,-4.354524),
                     row.names = c("octomanati","rinocaracol"))
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1b.RDS")

num_of_sims <- 100000 # use a subset of simulation from a total of 1 000 000

SS          <- target[1,"TD"]
SS_prime    <- ref_table[seq_len(num_of_sims),"TD"]
theta_prime <- ref_table$theta[seq_len(num_of_sims)]

tolerance <- 0.05
abc_result <- abc(target = SS,
                  param = theta_prime,
                  sumstat = SS_prime,
                  tol = tolerance,
                  method = "rejection")

theta_prime_accept     <- as.vector(abc_result$unadj.values)
hist(x = log10(theta_prime_accept),
     breaks = seq(-2,3,0.05),
     col = "blue",
     freq = FALSE,
     ylim = c(0,1), xlim=c(-1,2),
     xlab = expression(log(theta)),main="",
     ylab = "probability density")
```

```{r unexpected_prior-solution}
target <- data.frame(S  = c(50,23),
                     PI = c(11.56163,1.354286),
                     NH = c(21,18),
                     TD = c(0.123358,-2.386268),
                     FLD= c(-1.160349,-4.354524),
                     row.names = c("octomanati","rinocaracol"))
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1b.RDS")

num_of_sims <- 100000 # use a subset of simulation from a total of 1 000 000

SS          <- target[1,"TD"]
SS_prime    <- ref_table[seq_len(num_of_sims),"TD"]
theta_prime <- ref_table$theta[seq_len(num_of_sims)]

tolerance <- 0.05
abc_result <- abc(target = SS,
                  param = theta_prime,
                  sumstat = SS_prime,
                  tol = tolerance,
                  method = "rejection")

theta_prime_accept     <- as.vector(abc_result$unadj.values)
hist(x = log10(theta_prime_accept),
     breaks = seq(-2,3,0.05),
     col = "blue",
     freq = FALSE,
     ylim = c(0,1), xlim=c(-1,2),
     xlab = expression(log(theta)),main="",
     ylab = "probability density")
hist(x = log10(theta_prime),
     breaks = seq(-2,3,0.05),
     col = "grey", freq=FALSE, add=TRUE )
```


## Cross-validation

### Exercise 2

Use cross-validation function from `abc` package to evaluate the performance of the ABC method:

```{r cross_validation, exercise=TRUE, exercise.lines=15}
target <- data.frame(S  = c(50,23),
                     PI = c(11.56163,1.354286),
                     NH = c(21,18),
                     TD = c(0.123358,-2.386268),
                     row.names = c("octomanati","rinocaracol"))
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")

num_of_sims <- 10000

octomanati_result <- abc(target = target["octomanati",c("S","PI","NH","TD")],
                         param = ref_table[seq_len(num_of_sims),"theta"],
                         sumstat = ref_table[seq_len(num_of_sims),c("S","PI","NH","TD")],
                         tol = 0.1, method = "rejection")



```

```{r cross_validation-solution}

target <- data.frame(S  = c(50,23),
                     PI = c(11.56163,1.354286),
                     NH = c(21,18),
                     TD = c(0.123358,-2.386268),
                     FLD= c(-1.160349,-4.354524),
                     row.names = c("octomanati","rinocaracol"))
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")

num_of_sims <- 10000

octomanati_result <- abc(target = target["octomanati",c("S","PI","NH","TD")],
                         param = ref_table[seq_len(num_of_sims),"theta"],
                         sumstat = ref_table[seq_len(num_of_sims),c("S","PI","NH","TD")],
                         tol = 0.1, method = "rejection")



cross_validation <- cv4abc(param = ref_table[seq_len(num_of_sims),"theta"],
                           sumstat = ref_table[seq_len(num_of_sims),c("S","PI","NH","TD")],
                           abc.out = octomanati_result,
                           nval = 20,
                           tols = 0.1)

plot(log10(cross_validation$true$P1),
     log10(cross_validation$estim$tol0.1),
     xlab = expression(log(theta)),
     ylab = expression(log(hat(theta))),
     xlim = c(-1,2), ylim = c(-1,2))
abline(a = 0, b = 1)

```

## Goodness of fit

```{r prior_checking, exercise=TRUE, exercise.lines=15}
target <- data.frame(S  = c(50,23),
                     PI = c(11.56163,1.354286),
                     NH = c(21,18),
                     TD = c(0.123358,-2.386268),
                     FLD= c(-1.160349,-4.354524),
                     row.names = c("octomanati","rinocaracol"))
ref_table <- readRDS(file="/home/miguel/Work/Teaching/ABCRF tutorial/ref_table_1.RDS")

num_of_sims <- 10000

PCA_result  <- princomp(ref_table[!is.nan(ref_table$TD),c("S","PI","NH","TD")])
PCA_target <- predict(PCA_result, target[,c("S","PI","NH","TD")])
plot(PCA_result$scores[seq_len(num_of_sims),1],
     PCA_result$scores[seq_len(num_of_sims),2],
     xlab="PCA 1",ylab="PCA 2")
points(PCA_target[,1],PCA_target[,2],col="red")

```





